local _, ns = ...
--- @type NAG|AceAddon
local NAG = LibStub("AceAddon-3.0"):GetAddon("NAG")
local L = LibStub("AceLocale-3.0"):GetLocale("NAG", true)
--- @type Version
local Version = ns.Version
--- @type SpellTrackingManager|AceModule|ModuleBase
local SpellTracker = NAG:GetModule("SpellTrackingManager")
local SpecializationCompat = ns.SpecializationCompat

-- Dynamically build spec table for MAGE
local specNames = { "ARCANE", "FIRE", "FROST" }
local CLASS_SPECS = {}
for i, name in ipairs(specNames) do
    CLASS_SPECS[name] = SpecializationCompat:GetSpecID("MAGE", i)
end

local defaults = ns.InitializeClassDefaults()

-- MoP Mage spec spell locations
defaults.class.specSpellLocations = {
    [CLASS_SPECS.ARCANE] = {
        ABOVE = {11129},
        BELOW = {},
        RIGHT = {2136},
        LEFT = { 55342, 12051, 36799, 82731, 12042, 12043, 26297, 33702 },
        AOE = {}
    },
    [CLASS_SPECS.FIRE] = {
        ABOVE = {11129},
        BELOW = {},
        RIGHT = {2136},
        LEFT = { 55342, 12051, 36799, 82731, 12042, 12043, 26297, 33702 },
        AOE = {}
    },
    [CLASS_SPECS.FROST] = {
        ABOVE = {11129},
        BELOW = {},
        RIGHT = {2136},
        LEFT = { 55342, 12051, 36799, 82731, 12042, 12043, 26297, 33702 },
        AOE = {}
    }
}

-- ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ 
-- Leave below as is

if UnitClassBase('player') ~= "MAGE" then return end

-- START OF GENERATED_ROTATIONS

ns.AddRotationToDefaults(defaults,
    SpecializationCompat:GetSpecID("Mage", "Arcane"),
    "Mage Arcane - Default by APLParser",
    {
        -- Required parameters
        default = true,
        enabled = true,
        experimental = true,
        gameType = Version.GAME_TYPES.CLASSIC_MISTS,
        prePull = {
            { NAG:Cast(7302), -15000 }, { NAG:Cast(55342), -6500 }, { NAG:Cast(12051), -5000 }, { NAG:Cast(116011), -4000 }, { NAG:Cast(76093), -1900 }, { NAG:Cast(30451), -1900 }
        },
        rotationString = [[
            (NAG:AuraRemainingTime(116257) <= NAG:SpellCastTime(12051)) and NAG:Cast(12051)
    or (NAG:CurrentMana() <= 50000) and NAG:Cast(12051)
    or (NAG:SpellIsKnown(116011) and (NAG:AuraIsInactiveWithReactionTime(116011) or (NAG:AuraRemainingTime(116011) <= NAG:SpellCastTime(116011)))) and NAG:Cast(116011)
    or ((not NAG:AuraIsActiveWithReactionTime(44457, "target")) or (NAG:AuraRemainingTime(44457, "target") <= NAG:DotTickFrequency(44457))) and NAG:Cast(44457)
    or ((not NAG:DotIsActive(114923)) or (NAG:DotRemainingTime(114923) <= NAG:DotTickFrequency(114923))) and NAG:Cast(114923)
    or NAG:AuraIsInactiveWithReactionTime(112948, "target") and NAG:Cast(112948)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) >= 1)) and NAG:Cast(26297)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) >= 1)) and NAG:Cast(12042)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) >= 1) and NAG:AuraIsActive(12042)) and NAG:Cast(76093)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) >= 1)) and NAG:Cast(126734)
    or NAG:AutocastOtherCooldowns()
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) >= 1)) and NAG:Cast(108978)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) == 2)) and NAG:Cast(7268)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) <= 1) and (NAG:CurrentMana() <= 250000)) and NAG:Cast(36799)
    or ((NAG:RemainingTime() <= 35.0) and NAG:AuraIsActiveWithReactionTime(79683)) and NAG:Cast(7268)
    or ((NAG:RemainingTime() <= 35.0) and NAG:AuraIsInactiveWithReactionTime(79683)) and NAG:Cast(30451)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) == 1) and (NAG:CurrentManaPercent() >= 0.95)) and NAG:Cast(30451)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) == 1) and (NAG:CurrentManaPercent() < 0.95)) and NAG:Cast(7268)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) == 0) and (NAG:AuraRemainingTime(108978) > NAG:SpellCastTime(30451))) and NAG:Cast(30451)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) == 0) and (NAG:CurrentManaPercent() >= 0.95)) and NAG:Cast(30451)
    or ((NAG:AuraNumStacks(36032) == 4) and (NAG:AuraNumStacks(79683) == 0) and (NAG:CurrentManaPercent() < 0.9)) and NAG:Cast(44425)
    or ((NAG:AuraNumStacks(36032) <= 4) and (NAG:CurrentManaPercent() < 0.75) and (NAG:AuraRemainingTime(108978) <= NAG:SpellCastTime(30451))) and NAG:Cast(44425)
    or ((NAG:AuraNumStacks(36032) <= 3) and (NAG:AuraNumStacks(79683) == 2)) and NAG:Cast(7268)
    or (NAG:RemainingTime() <= NAG:SpellCastTime(30451)) and NAG:Cast(44425)
    or NAG:Cast(30451)
        ]],
        
        -- New action-based format
        --prePullActions = {{action = {castSpell = {spellId = {spellId = 7302}}}, doAtValue = {const = {val = "-15s"}}}, {action = {castSpell = {spellId = {spellId = 55342}}}, doAtValue = {const = {val = "-6.5s"}}}, {action = {castSpell = {spellId = {spellId = 12051}}}, doAtValue = {const = {val = "-5s"}}}, {action = {castSpell = {spellId = {spellId = 116011}}}, doAtValue = {const = {val = "-4s"}}}, {action = {castSpell = {spellId = {otherId = "OtherActionPotion"}}}, doAtValue = {const = {val = "-1.9s"}}}, {action = {castSpell = {spellId = {spellId = 30451}}}, doAtValue = {const = {val = "-1.9s"}}}},
        --aplActions = {{action = {condition = {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 116257}}}, rhs = {spellCastTime = {spellId = {spellId = 12051}}}}}, castSpell = {spellId = {spellId = 12051}}}}, {action = {condition = {cmp = {op = "OpLe", lhs = {currentMana = {}}, rhs = {const = {val = "50000"}}}}, castSpell = {spellId = {spellId = 12051}}}}, {action = {condition = {and = {vals = {{spellIsKnown = {spellId = {spellId = 116011}}}, {or = {vals = {{auraIsInactiveWithReactionTime = {auraId = {spellId = 116011}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 116011}}}, rhs = {spellCastTime = {spellId = {spellId = 116011}}}}}}}}}}}, castSpell = {spellId = {spellId = 116011}}}}, {action = {condition = {or = {vals = {{not = {val = {auraIsActiveWithReactionTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 44457, tag = 1}}}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 44457, tag = 1}}}, rhs = {dotTickFrequency = {spellId = {spellId = 44457}}}}}}}}, castSpell = {spellId = {spellId = 44457}}}}, {action = {condition = {or = {vals = {{not = {val = {dotIsActive = {spellId = {spellId = 114923}}}}}, {cmp = {op = "OpLe", lhs = {dotRemainingTime = {spellId = {spellId = 114923}}}, rhs = {dotTickFrequency = {spellId = {spellId = 114923}}}}}}}}, castSpell = {spellId = {spellId = 114923}}}}, {action = {condition = {auraIsInactiveWithReactionTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 112948}}}, castSpell = {spellId = {spellId = 112948}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpGe", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}}}}, castSpell = {spellId = {spellId = 26297}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpGe", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}}}}, castSpell = {spellId = {spellId = 12042}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpGe", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}, {auraIsActive = {auraId = {spellId = 12042}}}}}}, castSpell = {spellId = {itemId = 76093}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpGe", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}}}}, castSpell = {spellId = {spellId = 126734}}}}, {action = {autocastOtherCooldowns = {}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpGe", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}}}}, castSpell = {spellId = {spellId = 108978}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "2"}}}}}}}, castSpell = {spellId = {spellId = 7268}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpLe", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}, {cmp = {op = "OpLe", lhs = {currentMana = {}}, rhs = {const = {val = "250000"}}}}}}}, castSpell = {spellId = {itemId = 36799}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpLe", lhs = {remainingTime = {}}, rhs = {const = {val = "35s"}}}}, {auraIsActiveWithReactionTime = {auraId = {spellId = 79683}}}}}}, castSpell = {spellId = {spellId = 7268}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpLe", lhs = {remainingTime = {}}, rhs = {const = {val = "35s"}}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 79683}}}}}}, castSpell = {spellId = {spellId = 30451}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}, {cmp = {op = "OpGe", lhs = {currentManaPercent = {}}, rhs = {const = {val = "95%"}}}}}}}, castSpell = {spellId = {spellId = 30451}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "1"}}}}, {cmp = {op = "OpLt", lhs = {currentManaPercent = {}}, rhs = {const = {val = "95%"}}}}}}}, castSpell = {spellId = {spellId = 7268}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "0"}}}}, {cmp = {op = "OpGt", lhs = {auraRemainingTime = {auraId = {spellId = 108978}}}, rhs = {spellCastTime = {spellId = {spellId = 30451}}}}}}}}, castSpell = {spellId = {spellId = 30451}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "0"}}}}, {cmp = {op = "OpGe", lhs = {currentManaPercent = {}}, rhs = {const = {val = "95%"}}}}}}}, castSpell = {spellId = {spellId = 30451}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "0"}}}}, {cmp = {op = "OpLt", lhs = {currentManaPercent = {}}, rhs = {const = {val = "90%"}}}}}}}, castSpell = {spellId = {spellId = 44425}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpLe", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "4"}}}}, {cmp = {op = "OpLt", lhs = {currentManaPercent = {}}, rhs = {const = {val = "75%"}}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 108978}}}, rhs = {spellCastTime = {spellId = {spellId = 30451}}}}}, {}}}}, castSpell = {spellId = {spellId = 44425}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpLe", lhs = {auraNumStacks = {auraId = {spellId = 36032}}}, rhs = {const = {val = "3"}}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 79683}}}, rhs = {const = {val = "2"}}}}}}}, castSpell = {spellId = {spellId = 7268}}}}, {action = {condition = {cmp = {op = "OpLe", lhs = {remainingTime = {}}, rhs = {spellCastTime = {spellId = {spellId = 30451}}}}}, castSpell = {spellId = {spellId = 44425}}}}, {action = {castSpell = {spellId = {spellId = 30451}}}}},

        -- Tracked IDs for optimization
        spells = {7268, 12042, 12051, 26297, 30451, 36032, 44425, 44457, 79683, 108978, 112948, 114923, 116011, 116257, 126734},
        items = {36799, 76093},
        auras = {},
        runes = {},

        -- Optional metadata
        glyphs = {44955, 42748, 42738, 42743, 63416, 45739},
        lastModified = "07/03/2025",
        author = "APLParser",

        -- Serialized JSON for straight APL reading
        --rotation_json = [[[{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":116257}}},"rhs":{"spellCastTime":{"spellId":{"spellId":12051}}}}},"castSpell":{"spellId":{"spellId":12051}}}},{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"currentMana":{}},"rhs":{"const":{"val":"50000"}}}},"castSpell":{"spellId":{"spellId":12051}}}},{"action":{"condition":{"and":{"vals":[{"spellIsKnown":{"spellId":{"spellId":116011}}},{"or":{"vals":[{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":116011}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":116011}}},"rhs":{"spellCastTime":{"spellId":{"spellId":116011}}}}}]}}]}},"castSpell":{"spellId":{"spellId":116011}}}},{"action":{"condition":{"or":{"vals":[{"not":{"val":{"auraIsActiveWithReactionTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":44457,"tag":1}}}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":44457,"tag":1}}},"rhs":{"dotTickFrequency":{"spellId":{"spellId":44457}}}}}]}},"castSpell":{"spellId":{"spellId":44457}}}},{"action":{"condition":{"or":{"vals":[{"not":{"val":{"dotIsActive":{"spellId":{"spellId":114923}}}}},{"cmp":{"op":"OpLe","lhs":{"dotRemainingTime":{"spellId":{"spellId":114923}}},"rhs":{"dotTickFrequency":{"spellId":{"spellId":114923}}}}}]}},"castSpell":{"spellId":{"spellId":114923}}}},{"action":{"condition":{"auraIsInactiveWithReactionTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":112948}}},"castSpell":{"spellId":{"spellId":112948}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpGe","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}}]}},"castSpell":{"spellId":{"spellId":26297}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpGe","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}}]}},"castSpell":{"spellId":{"spellId":12042}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpGe","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}},{"auraIsActive":{"auraId":{"spellId":12042}}}]}},"castSpell":{"spellId":{"itemId":76093}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpGe","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}}]}},"castSpell":{"spellId":{"spellId":126734}}}},{"action":{"autocastOtherCooldowns":{}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpGe","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}}]}},"castSpell":{"spellId":{"spellId":108978}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"2"}}}}]}},"castSpell":{"spellId":{"spellId":7268}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpLe","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}},{"cmp":{"op":"OpLe","lhs":{"currentMana":{}},"rhs":{"const":{"val":"250000"}}}}]}},"castSpell":{"spellId":{"itemId":36799}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpLe","lhs":{"remainingTime":{}},"rhs":{"const":{"val":"35s"}}}},{"auraIsActiveWithReactionTime":{"auraId":{"spellId":79683}}}]}},"castSpell":{"spellId":{"spellId":7268}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpLe","lhs":{"remainingTime":{}},"rhs":{"const":{"val":"35s"}}}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":79683}}}]}},"castSpell":{"spellId":{"spellId":30451}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}},{"cmp":{"op":"OpGe","lhs":{"currentManaPercent":{}},"rhs":{"const":{"val":"95%"}}}}]}},"castSpell":{"spellId":{"spellId":30451}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"1"}}}},{"cmp":{"op":"OpLt","lhs":{"currentManaPercent":{}},"rhs":{"const":{"val":"95%"}}}}]}},"castSpell":{"spellId":{"spellId":7268}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"0"}}}},{"cmp":{"op":"OpGt","lhs":{"auraRemainingTime":{"auraId":{"spellId":108978}}},"rhs":{"spellCastTime":{"spellId":{"spellId":30451}}}}}]}},"castSpell":{"spellId":{"spellId":30451}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"0"}}}},{"cmp":{"op":"OpGe","lhs":{"currentManaPercent":{}},"rhs":{"const":{"val":"95%"}}}}]}},"castSpell":{"spellId":{"spellId":30451}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"0"}}}},{"cmp":{"op":"OpLt","lhs":{"currentManaPercent":{}},"rhs":{"const":{"val":"90%"}}}}]}},"castSpell":{"spellId":{"spellId":44425}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpLe","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"4"}}}},{"cmp":{"op":"OpLt","lhs":{"currentManaPercent":{}},"rhs":{"const":{"val":"75%"}}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":108978}}},"rhs":{"spellCastTime":{"spellId":{"spellId":30451}}}}},{}]}},"castSpell":{"spellId":{"spellId":44425}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpLe","lhs":{"auraNumStacks":{"auraId":{"spellId":36032}}},"rhs":{"const":{"val":"3"}}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":79683}}},"rhs":{"const":{"val":"2"}}}}]}},"castSpell":{"spellId":{"spellId":7268}}}},{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"remainingTime":{}},"rhs":{"spellCastTime":{"spellId":{"spellId":30451}}}}},"castSpell":{"spellId":{"spellId":44425}}}},{"action":{"castSpell":{"spellId":{"spellId":30451}}}}]]],
        --prepull_json = [[[{"action":{"castSpell":{"spellId":{"spellId":7302}}},"doAtValue":{"const":{"val":"-15s"}}},{"action":{"castSpell":{"spellId":{"spellId":55342}}},"doAtValue":{"const":{"val":"-6.5s"}}},{"action":{"castSpell":{"spellId":{"spellId":12051}}},"doAtValue":{"const":{"val":"-5s"}}},{"action":{"castSpell":{"spellId":{"spellId":116011}}},"doAtValue":{"const":{"val":"-4s"}}},{"action":{"castSpell":{"spellId":{"otherId":"OtherActionPotion"}}},"doAtValue":{"const":{"val":"-1.9s"}}},{"action":{"castSpell":{"spellId":{"spellId":30451}}},"doAtValue":{"const":{"val":"-1.9s"}}}]]]
    }
)


ns.AddRotationToDefaults(defaults,
    SpecializationCompat:GetSpecID("Mage", "Fire"),
    "Mage Fire - Default by APLParser",
    {
        -- Required parameters
        default = true,
        enabled = true,
        experimental = true,
        gameType = Version.GAME_TYPES.CLASSIC_MISTS,
        prePull = {
            { NAG:Cast(30482), -10000 }, { NAG:Cast(12051), -6500 }, { NAG:Cast(116011), -5900 }, { NAG:Cast(55342), -4400 }, { NAG:Cast(11366), -2900 }, { NAG:Cast(76093), -2900 }
        },
        rotationString = [[
            NAG:AutocastOtherCooldowns()
    or (NAG:AuraRemainingTime(116257) <= NAG:SpellCastTime(12051)) and NAG:Cast(12051)
    or (NAG:CurrentMana() <= 30000) and NAG:Cast(12051)
    or (NAG:SpellIsKnown(116011) and (NAG:AuraIsInactiveWithReactionTime(116011) or (NAG:AuraRemainingTime(116011) <= NAG:SpellCastTime(116011)))) and NAG:Cast(116011)
    or (NAG:AuraIsActive(48107) and (not NAG:AuraIsActive(48108))) and NAG:Cast(108853)
    or ((not NAG:AuraIsActiveWithReactionTime(44457, "target")) or (NAG:AuraRemainingTime(44457, "target") <= NAG:DotTickFrequency(44457))) and NAG:Cast(44457)
    or ((not NAG:DotIsActive(114923)) or (NAG:DotRemainingTime(114923) <= NAG:DotTickFrequency(114923))) and NAG:Cast(114923)
    or NAG:AuraIsInactiveWithReactionTime(112948, "target") and NAG:Cast(112948)
    or ((NAG:SpellTimeToReady(11129) <= 5.0) and (not NAG:SpellIsReady(11129)) and NAG:AuraIsActive(48108) and NAG:AuraIsInactiveWithReactionTime(48107) and (not NAG:AuraIsActive(12043))) and NAG:Cast(133)
    or ((NAG:SpellIsReady(108978) or (NAG:SpellTimeToReady(108978) >= 85.0)) and (NAG:SpellIsReady(11129) or (NAG:SpellTimeToReady(11129) <= 5.0)) and NAG:AuraIsActive(48108) and NAG:AuraIsActive(48107)) and NAG:Cast(12043)
    or (NAG:SpellIsReady(108978) or (NAG:SpellTimeToReady(108978) >= 75.0)) and NAG:Cast(26297)
    or (NAG:SpellIsReady(108978) and NAG:AuraIsActive(48108) and NAG:AuraIsActive(48107)) and NAG:Cast(76093)
    or (NAG:AuraIsActive(48108) and NAG:AuraIsActive(48107)) and NAG:Cast(108978)
    or (((NAG:AuraIsActive(12043) or NAG:AuraIsActive(48108)) and NAG:AuraIsActive(108978)) or (NAG:AuraIsActive(48108) and (NAG:SpellTimeToReady(11129) >= 5.0)) or (NAG:AuraIsActive(48108) and NAG:AuraIsActive(48107))) and NAG:Cast(11366)
    or (NAG:AuraIsActive(108978) and NAG:AuraIsInactiveWithReactionTime(48108) and NAG:AuraIsInactiveWithReactionTime(48107) and NAG:AuraIsInactiveWithReactionTime(12043)) and NAG:Cast(108978)
    or (((NAG:MageCurrentCombustionDotEstimate() >= 430000) and (NAG:AuraIsInactiveWithReactionTime(48107) and (not NAG:SpellIsReady(108853))) and NAG:AuraIsInactiveWithReactionTime(48108) and NAG:AuraIsInactiveWithReactionTime(12043)) or (NAG:MageCurrentCombustionDotEstimate() >= 750000)) and NAG:Cast(11129)
    or NAG:Cast(133)
        ]],
        
        -- New action-based format
        --prePullActions = {{action = {castSpell = {spellId = {spellId = 30482}}}, doAtValue = {const = {val = "-10s"}}}, {action = {castSpell = {spellId = {spellId = 12051}}}, doAtValue = {const = {val = "-6.5s"}}}, {action = {castSpell = {spellId = {spellId = 116011}}}, doAtValue = {const = {val = "-5.9s"}}}, {action = {castSpell = {spellId = {spellId = 55342}}}, doAtValue = {const = {val = "-4.4s"}}}, {action = {castSpell = {spellId = {spellId = 11366}}}, doAtValue = {const = {val = "-2.9s"}}}, {action = {castSpell = {spellId = {otherId = "OtherActionPotion"}}}, doAtValue = {const = {val = "-2.9s"}}}},
        --aplActions = {{action = {autocastOtherCooldowns = {}}}, {action = {condition = {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 116257}}}, rhs = {spellCastTime = {spellId = {spellId = 12051}}}}}, castSpell = {spellId = {spellId = 12051}}}}, {action = {condition = {cmp = {op = "OpLe", lhs = {currentMana = {}}, rhs = {const = {val = "30000"}}}}, castSpell = {spellId = {spellId = 12051}}}}, {action = {condition = {and = {vals = {{spellIsKnown = {spellId = {spellId = 116011}}}, {or = {vals = {{auraIsInactiveWithReactionTime = {auraId = {spellId = 116011}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 116011}}}, rhs = {spellCastTime = {spellId = {spellId = 116011}}}}}}}}}}}, castSpell = {spellId = {spellId = 116011}}}}, {action = {condition = {and = {vals = {{auraIsActive = {auraId = {spellId = 48107}}}, {not = {val = {auraIsActive = {auraId = {spellId = 48108}}}}}}}}, castSpell = {spellId = {spellId = 108853}}}}, {action = {condition = {or = {vals = {{not = {val = {auraIsActiveWithReactionTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 44457, tag = 1}}}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 44457, tag = 1}}}, rhs = {dotTickFrequency = {spellId = {spellId = 44457}}}}}}}}, castSpell = {spellId = {spellId = 44457}}}}, {action = {condition = {or = {vals = {{not = {val = {dotIsActive = {spellId = {spellId = 114923}}}}}, {cmp = {op = "OpLe", lhs = {dotRemainingTime = {spellId = {spellId = 114923}}}, rhs = {dotTickFrequency = {spellId = {spellId = 114923}}}}}}}}, castSpell = {spellId = {spellId = 114923}}}}, {action = {condition = {auraIsInactiveWithReactionTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 112948}}}, castSpell = {spellId = {spellId = 112948}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpLe", lhs = {spellTimeToReady = {spellId = {spellId = 11129}}}, rhs = {const = {val = "5s"}}}}, {not = {val = {spellIsReady = {spellId = {spellId = 11129}}}}}, {auraIsActive = {auraId = {spellId = 48108}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 48107}}}, {not = {val = {auraIsActive = {auraId = {spellId = 12043}}}}}}}}, castSpell = {spellId = {spellId = 133}}}}, {action = {condition = {and = {vals = {{or = {vals = {{spellIsReady = {spellId = {spellId = 108978}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 108978}}}, rhs = {const = {val = "85s"}}}}}}}, {or = {vals = {{spellIsReady = {spellId = {spellId = 11129}}}, {cmp = {op = "OpLe", lhs = {spellTimeToReady = {spellId = {spellId = 11129}}}, rhs = {const = {val = "5s"}}}}}}}, {auraIsActive = {auraId = {spellId = 48108}}}, {auraIsActive = {auraId = {spellId = 48107}}}}}}, castSpell = {spellId = {spellId = 12043}}}}, {action = {condition = {or = {vals = {{spellIsReady = {spellId = {spellId = 108978}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 108978}}}, rhs = {const = {val = "75s"}}}}}}}, castSpell = {spellId = {spellId = 26297}}}}, {action = {condition = {and = {vals = {{spellIsReady = {spellId = {spellId = 108978}}}, {auraIsActive = {auraId = {spellId = 48108}}}, {auraIsActive = {auraId = {spellId = 48107}}}}}}, castSpell = {spellId = {itemId = 76093}}}}, {action = {condition = {and = {vals = {{auraIsActive = {auraId = {spellId = 48108}}}, {auraIsActive = {auraId = {spellId = 48107}}}}}}, castSpell = {spellId = {spellId = 108978}}}}, {action = {condition = {or = {vals = {{and = {vals = {{or = {vals = {{auraIsActive = {auraId = {spellId = 12043}}}, {auraIsActive = {auraId = {spellId = 48108}}}}}}, {auraIsActive = {auraId = {spellId = 108978}}}}}}, {and = {vals = {{auraIsActive = {auraId = {spellId = 48108}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 11129}}}, rhs = {const = {val = "5s"}}}}}}}, {and = {vals = {{auraIsActive = {auraId = {spellId = 48108}}}, {auraIsActive = {auraId = {spellId = 48107}}}}}}}}}, castSpell = {spellId = {spellId = 11366}}}}, {action = {condition = {and = {vals = {{auraIsActive = {auraId = {spellId = 108978}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 48108}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 48107}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 12043}}}}}}, castSpell = {spellId = {spellId = 108978, tag = 1}}}}, {action = {condition = {or = {vals = {{and = {vals = {{cmp = {op = "OpGe", lhs = {mageCurrentCombustionDotEstimate = {}}, rhs = {const = {val = "430000"}}}}, {and = {vals = {{auraIsInactiveWithReactionTime = {auraId = {spellId = 48107}}}, {not = {val = {spellIsReady = {spellId = {spellId = 108853}}}}}}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 48108}}}, {auraIsInactiveWithReactionTime = {auraId = {spellId = 12043}}}}}}, {cmp = {op = "OpGe", lhs = {mageCurrentCombustionDotEstimate = {}}, rhs = {const = {val = "750000"}}}}}}}, castSpell = {spellId = {spellId = 11129}}}}, {action = {castSpell = {spellId = {spellId = 133}}}}},

        -- Tracked IDs for optimization
        spells = {133, 11129, 11366, 12043, 12051, 26297, 44457, 48107, 48108, 108853, 108978, 112948, 114923, 116011, 116257},
        items = {76093},
        auras = {},
        runes = {},

        -- Optional metadata
        glyphs = {42739, 63539, 42749, 42743, 45739, 104104},
        lastModified = "07/03/2025",
        author = "APLParser",

        -- Serialized JSON for straight APL reading
        --rotation_json = [[[{"action":{"autocastOtherCooldowns":{}}},{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":116257}}},"rhs":{"spellCastTime":{"spellId":{"spellId":12051}}}}},"castSpell":{"spellId":{"spellId":12051}}}},{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"currentMana":{}},"rhs":{"const":{"val":"30000"}}}},"castSpell":{"spellId":{"spellId":12051}}}},{"action":{"condition":{"and":{"vals":[{"spellIsKnown":{"spellId":{"spellId":116011}}},{"or":{"vals":[{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":116011}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":116011}}},"rhs":{"spellCastTime":{"spellId":{"spellId":116011}}}}}]}}]}},"castSpell":{"spellId":{"spellId":116011}}}},{"action":{"condition":{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":48107}}},{"not":{"val":{"auraIsActive":{"auraId":{"spellId":48108}}}}}]}},"castSpell":{"spellId":{"spellId":108853}}}},{"action":{"condition":{"or":{"vals":[{"not":{"val":{"auraIsActiveWithReactionTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":44457,"tag":1}}}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":44457,"tag":1}}},"rhs":{"dotTickFrequency":{"spellId":{"spellId":44457}}}}}]}},"castSpell":{"spellId":{"spellId":44457}}}},{"action":{"condition":{"or":{"vals":[{"not":{"val":{"dotIsActive":{"spellId":{"spellId":114923}}}}},{"cmp":{"op":"OpLe","lhs":{"dotRemainingTime":{"spellId":{"spellId":114923}}},"rhs":{"dotTickFrequency":{"spellId":{"spellId":114923}}}}}]}},"castSpell":{"spellId":{"spellId":114923}}}},{"action":{"condition":{"auraIsInactiveWithReactionTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":112948}}},"castSpell":{"spellId":{"spellId":112948}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpLe","lhs":{"spellTimeToReady":{"spellId":{"spellId":11129}}},"rhs":{"const":{"val":"5s"}}}},{"not":{"val":{"spellIsReady":{"spellId":{"spellId":11129}}}}},{"auraIsActive":{"auraId":{"spellId":48108}}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":48107}}},{"not":{"val":{"auraIsActive":{"auraId":{"spellId":12043}}}}}]}},"castSpell":{"spellId":{"spellId":133}}}},{"action":{"condition":{"and":{"vals":[{"or":{"vals":[{"spellIsReady":{"spellId":{"spellId":108978}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":108978}}},"rhs":{"const":{"val":"85s"}}}}]}},{"or":{"vals":[{"spellIsReady":{"spellId":{"spellId":11129}}},{"cmp":{"op":"OpLe","lhs":{"spellTimeToReady":{"spellId":{"spellId":11129}}},"rhs":{"const":{"val":"5s"}}}}]}},{"auraIsActive":{"auraId":{"spellId":48108}}},{"auraIsActive":{"auraId":{"spellId":48107}}}]}},"castSpell":{"spellId":{"spellId":12043}}}},{"action":{"condition":{"or":{"vals":[{"spellIsReady":{"spellId":{"spellId":108978}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":108978}}},"rhs":{"const":{"val":"75s"}}}}]}},"castSpell":{"spellId":{"spellId":26297}}}},{"action":{"condition":{"and":{"vals":[{"spellIsReady":{"spellId":{"spellId":108978}}},{"auraIsActive":{"auraId":{"spellId":48108}}},{"auraIsActive":{"auraId":{"spellId":48107}}}]}},"castSpell":{"spellId":{"itemId":76093}}}},{"action":{"condition":{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":48108}}},{"auraIsActive":{"auraId":{"spellId":48107}}}]}},"castSpell":{"spellId":{"spellId":108978}}}},{"action":{"condition":{"or":{"vals":[{"and":{"vals":[{"or":{"vals":[{"auraIsActive":{"auraId":{"spellId":12043}}},{"auraIsActive":{"auraId":{"spellId":48108}}}]}},{"auraIsActive":{"auraId":{"spellId":108978}}}]}},{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":48108}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":11129}}},"rhs":{"const":{"val":"5s"}}}}]}},{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":48108}}},{"auraIsActive":{"auraId":{"spellId":48107}}}]}}]}},"castSpell":{"spellId":{"spellId":11366}}}},{"action":{"condition":{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":108978}}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":48108}}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":48107}}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":12043}}}]}},"castSpell":{"spellId":{"spellId":108978,"tag":1}}}},{"action":{"condition":{"or":{"vals":[{"and":{"vals":[{"cmp":{"op":"OpGe","lhs":{"mageCurrentCombustionDotEstimate":{}},"rhs":{"const":{"val":"430000"}}}},{"and":{"vals":[{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":48107}}},{"not":{"val":{"spellIsReady":{"spellId":{"spellId":108853}}}}}]}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":48108}}},{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":12043}}}]}},{"cmp":{"op":"OpGe","lhs":{"mageCurrentCombustionDotEstimate":{}},"rhs":{"const":{"val":"750000"}}}}]}},"castSpell":{"spellId":{"spellId":11129}}}},{"action":{"castSpell":{"spellId":{"spellId":133}}}}]]],
        --prepull_json = [[[{"action":{"castSpell":{"spellId":{"spellId":30482}}},"doAtValue":{"const":{"val":"-10s"}}},{"action":{"castSpell":{"spellId":{"spellId":12051}}},"doAtValue":{"const":{"val":"-6.5s"}}},{"action":{"castSpell":{"spellId":{"spellId":116011}}},"doAtValue":{"const":{"val":"-5.9s"}}},{"action":{"castSpell":{"spellId":{"spellId":55342}}},"doAtValue":{"const":{"val":"-4.4s"}}},{"action":{"castSpell":{"spellId":{"spellId":11366}}},"doAtValue":{"const":{"val":"-2.9s"}}},{"action":{"castSpell":{"spellId":{"otherId":"OtherActionPotion"}}},"doAtValue":{"const":{"val":"-2.9s"}}}]]]
    }
)

ns.AddRotationToDefaults(defaults,
    SpecializationCompat:GetSpecID("Mage", "Frost"),
    "Mage Frost - Default by APLParser",
    {
        -- Required parameters
        default = true,
        enabled = true,
        experimental = true,
        gameType = Version.GAME_TYPES.CLASSIC_MISTS,
        prePull = {
            { NAG:Cast(31687), -15000 }, { NAG:Cast(7302), -8000 }, { NAG:Cast(12051), -5000 }, { NAG:Cast(116011), -5000 }, { NAG:Cast(55342), -3500 }, { NAG:Cast(116), -1500 }, { NAG:Cast(76093), -1500 }
        },
        rotationString = [[
            NAG:AutocastOtherCooldowns()
    or (NAG:AuraRemainingTime(116257) <= NAG:SpellCastTime(12051)) and NAG:Cast(12051)
    or (NAG:CurrentMana() <= 45000) and NAG:Cast(12051)
    or (NAG:SpellIsKnown(116011) and (NAG:AuraIsInactiveWithReactionTime(116011) or (NAG:AuraRemainingTime(116011) <= NAG:SpellCastTime(116011)))) and NAG:Cast(116011)
    or (NAG:SpellIsReady(108978) or (NAG:SpellTimeToReady(108978) >= 50.0)) and NAG:Cast(126734)
    or (NAG:SpellIsReady(108978) or (NAG:SpellTimeToReady(108978) >= 75.0)) and NAG:Cast(12472)
    or (NAG:SpellIsReady(108978) and (NAG:AuraNumStacks(112965) == 2) and NAG:AuraIsActive(44549)) and NAG:Cast(76093)
    or ((NAG:AuraNumStacks(112965) == 2) and NAG:AuraIsActive(44549) and (NAG:AuraIsActive(12472) or NAG:AuraIsActive(33697) or NAG:AuraIsActive(76093) or NAG:AuraIsActive(126734) or NAG:AuraIsActive(26297) or (NAG:NumEquippedStatProcTrinkets(3, 7, 6) >= 2)) and (NAG:AuraIsActive(2825) or (NAG:AuraRemainingTime(57724) >= 180.0))) and NAG:Cast(108978)
    or (NAG:AuraNumStacks(112965) == 2) and NAG:Cast(30455)
    or (NAG:AuraIsActive(44549) and (NAG:SpellTimeToReady(108978) >= 10.0)) and NAG:Cast(44614)
    or ((not NAG:DotIsActive(44457)) or (NAG:AuraRemainingTime(44457, "target") <= NAG:DotTickFrequency(44457))) and NAG:Cast(44457)
    or ((not NAG:DotIsActive(114923)) or (NAG:DotRemainingTime(114923) <= NAG:DotTickFrequency(114923))) and NAG:Cast(114923)
    or NAG:AuraIsInactiveWithReactionTime(112948, "target") and NAG:Cast(112948)
    or NAG:SpellIsReady(84714) and NAG:Cast(84714)
    or (NAG:AuraIsActive(112965) and (NAG:SpellTimeToReady(108978) >= 10.0)) and NAG:Cast(30455)
    or NAG:Cast(116)
        ]],
        
        -- New action-based format
        --prePullActions = {{action = {castSpell = {spellId = {spellId = 31687}}}, doAtValue = {const = {val = "-15s"}}}, {action = {castSpell = {spellId = {spellId = 7302}}}, doAtValue = {const = {val = "-8s"}}}, {action = {castSpell = {spellId = {spellId = 12051}}}, doAtValue = {const = {val = "-5s"}}}, {action = {castSpell = {spellId = {spellId = 116011}}}, doAtValue = {const = {val = "-5s"}}}, {action = {castSpell = {spellId = {spellId = 55342}}}, doAtValue = {const = {val = "-3.5s"}}}, {action = {castSpell = {spellId = {spellId = 116}}}, doAtValue = {const = {val = "-1.5s"}}}, {action = {castSpell = {spellId = {otherId = "OtherActionPotion"}}}, doAtValue = {const = {val = "-1.5s"}}}},
        --aplActions = {{action = {autocastOtherCooldowns = {}}}, {action = {condition = {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 116257}}}, rhs = {spellCastTime = {spellId = {spellId = 12051}}}}}, castSpell = {spellId = {spellId = 12051}}}}, {action = {condition = {cmp = {op = "OpLe", lhs = {currentMana = {}}, rhs = {const = {val = "45000"}}}}, castSpell = {spellId = {spellId = 12051}}}}, {action = {condition = {and = {vals = {{spellIsKnown = {spellId = {spellId = 116011}}}, {or = {vals = {{auraIsInactiveWithReactionTime = {auraId = {spellId = 116011}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {auraId = {spellId = 116011}}}, rhs = {spellCastTime = {spellId = {spellId = 116011}}}}}}}}}}}, castSpell = {spellId = {spellId = 116011}}}}, {action = {condition = {or = {vals = {{spellIsReady = {spellId = {spellId = 108978}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 108978}}}, rhs = {const = {val = "50s"}}}}}}}, castSpell = {spellId = {spellId = 126734}}}}, {action = {condition = {or = {vals = {{spellIsReady = {spellId = {spellId = 108978}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 108978}}}, rhs = {const = {val = "75s"}}}}}}}, castSpell = {spellId = {spellId = 12472}}}}, {action = {condition = {and = {vals = {{spellIsReady = {spellId = {spellId = 108978}}}, {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 112965}}}, rhs = {const = {val = "2"}}}}, {auraIsActive = {auraId = {spellId = 44549}}}}}}, castSpell = {spellId = {itemId = 76093}}}}, {action = {condition = {and = {vals = {{cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 112965}}}, rhs = {const = {val = "2"}}}}, {auraIsActive = {auraId = {spellId = 44549}}}, {or = {vals = {{auraIsActive = {auraId = {spellId = 12472}}}, {auraIsActive = {auraId = {spellId = 33697}}}, {auraIsActive = {auraId = {itemId = 76093}}}, {auraIsActive = {auraId = {spellId = 126734}}}, {auraIsActive = {auraId = {spellId = 26297}}}, {cmp = {op = "OpGe", lhs = {numEquippedStatProcTrinkets = {statType1 = 3, statType2 = 7, statType3 = 6}}, rhs = {const = {val = "2"}}}}}}}, {or = {vals = {{auraIsActive = {auraId = {spellId = 2825, tag = -1}}}, {cmp = {op = "OpGe", lhs = {auraRemainingTime = {auraId = {spellId = 57724}}}, rhs = {const = {val = "180s"}}}}}}}, {}}}}, castSpell = {spellId = {spellId = 108978}}}}, {action = {condition = {cmp = {op = "OpEq", lhs = {auraNumStacks = {auraId = {spellId = 112965}}}, rhs = {const = {val = "2"}}}}, castSpell = {spellId = {spellId = 30455}}}}, {action = {condition = {and = {vals = {{auraIsActive = {auraId = {spellId = 44549}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 108978}}}, rhs = {const = {val = "10s"}}}}}}}, castSpell = {spellId = {spellId = 44614}}}}, {action = {condition = {or = {vals = {{not = {val = {dotIsActive = {spellId = {spellId = 44457}}}}}, {cmp = {op = "OpLe", lhs = {auraRemainingTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 44457, tag = 1}}}, rhs = {dotTickFrequency = {spellId = {spellId = 44457}}}}}}}}, castSpell = {spellId = {spellId = 44457}}}}, {action = {condition = {or = {vals = {{not = {val = {dotIsActive = {spellId = {spellId = 114923}}}}}, {cmp = {op = "OpLe", lhs = {dotRemainingTime = {spellId = {spellId = 114923}}}, rhs = {dotTickFrequency = {spellId = {spellId = 114923}}}}}}}}, castSpell = {spellId = {spellId = 114923}}}}, {action = {condition = {auraIsInactiveWithReactionTime = {sourceUnit = {type = "CurrentTarget"}, auraId = {spellId = 112948}}}, castSpell = {spellId = {spellId = 112948}}}}, {action = {condition = {spellIsReady = {spellId = {spellId = 84714}}}, castSpell = {spellId = {spellId = 84714}}}}, {action = {condition = {and = {vals = {{auraIsActive = {auraId = {spellId = 112965}}}, {cmp = {op = "OpGe", lhs = {spellTimeToReady = {spellId = {spellId = 108978}}}, rhs = {const = {val = "10s"}}}}}}}, castSpell = {spellId = {spellId = 30455}}}}, {action = {castSpell = {spellId = {spellId = 116}}}}},

        -- Tracked IDs for optimization
        spells = {116, 2825, 12051, 12472, 26297, 30455, 33697, 44457, 44549, 44614, 57724, 84714, 108978, 112948, 112965, 114923, 116011, 116257, 126734},
        items = {76093},
        auras = {},
        runes = {},

        -- Optional metadata
        glyphs = {42745, 42753, 45736, 42743, 45739, 104104},
        lastModified = "07/03/2025",
        author = "APLParser",

        -- Serialized JSON for straight APL reading
        --rotation_json = [[[{"action":{"autocastOtherCooldowns":{}}},{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":116257}}},"rhs":{"spellCastTime":{"spellId":{"spellId":12051}}}}},"castSpell":{"spellId":{"spellId":12051}}}},{"action":{"condition":{"cmp":{"op":"OpLe","lhs":{"currentMana":{}},"rhs":{"const":{"val":"45000"}}}},"castSpell":{"spellId":{"spellId":12051}}}},{"action":{"condition":{"and":{"vals":[{"spellIsKnown":{"spellId":{"spellId":116011}}},{"or":{"vals":[{"auraIsInactiveWithReactionTime":{"auraId":{"spellId":116011}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"auraId":{"spellId":116011}}},"rhs":{"spellCastTime":{"spellId":{"spellId":116011}}}}}]}}]}},"castSpell":{"spellId":{"spellId":116011}}}},{"action":{"condition":{"or":{"vals":[{"spellIsReady":{"spellId":{"spellId":108978}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":108978}}},"rhs":{"const":{"val":"50s"}}}}]}},"castSpell":{"spellId":{"spellId":126734}}}},{"action":{"condition":{"or":{"vals":[{"spellIsReady":{"spellId":{"spellId":108978}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":108978}}},"rhs":{"const":{"val":"75s"}}}}]}},"castSpell":{"spellId":{"spellId":12472}}}},{"action":{"condition":{"and":{"vals":[{"spellIsReady":{"spellId":{"spellId":108978}}},{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":112965}}},"rhs":{"const":{"val":"2"}}}},{"auraIsActive":{"auraId":{"spellId":44549}}}]}},"castSpell":{"spellId":{"itemId":76093}}}},{"action":{"condition":{"and":{"vals":[{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":112965}}},"rhs":{"const":{"val":"2"}}}},{"auraIsActive":{"auraId":{"spellId":44549}}},{"or":{"vals":[{"auraIsActive":{"auraId":{"spellId":12472}}},{"auraIsActive":{"auraId":{"spellId":33697}}},{"auraIsActive":{"auraId":{"itemId":76093}}},{"auraIsActive":{"auraId":{"spellId":126734}}},{"auraIsActive":{"auraId":{"spellId":26297}}},{"cmp":{"op":"OpGe","lhs":{"numEquippedStatProcTrinkets":{"statType1":3,"statType2":7,"statType3":6}},"rhs":{"const":{"val":"2"}}}}]}},{"or":{"vals":[{"auraIsActive":{"auraId":{"spellId":2825,"tag":-1}}},{"cmp":{"op":"OpGe","lhs":{"auraRemainingTime":{"auraId":{"spellId":57724}}},"rhs":{"const":{"val":"180s"}}}}]}},{}]}},"castSpell":{"spellId":{"spellId":108978}}}},{"action":{"condition":{"cmp":{"op":"OpEq","lhs":{"auraNumStacks":{"auraId":{"spellId":112965}}},"rhs":{"const":{"val":"2"}}}},"castSpell":{"spellId":{"spellId":30455}}}},{"action":{"condition":{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":44549}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":108978}}},"rhs":{"const":{"val":"10s"}}}}]}},"castSpell":{"spellId":{"spellId":44614}}}},{"action":{"condition":{"or":{"vals":[{"not":{"val":{"dotIsActive":{"spellId":{"spellId":44457}}}}},{"cmp":{"op":"OpLe","lhs":{"auraRemainingTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":44457,"tag":1}}},"rhs":{"dotTickFrequency":{"spellId":{"spellId":44457}}}}}]}},"castSpell":{"spellId":{"spellId":44457}}}},{"action":{"condition":{"or":{"vals":[{"not":{"val":{"dotIsActive":{"spellId":{"spellId":114923}}}}},{"cmp":{"op":"OpLe","lhs":{"dotRemainingTime":{"spellId":{"spellId":114923}}},"rhs":{"dotTickFrequency":{"spellId":{"spellId":114923}}}}}]}},"castSpell":{"spellId":{"spellId":114923}}}},{"action":{"condition":{"auraIsInactiveWithReactionTime":{"sourceUnit":{"type":"CurrentTarget"},"auraId":{"spellId":112948}}},"castSpell":{"spellId":{"spellId":112948}}}},{"action":{"condition":{"spellIsReady":{"spellId":{"spellId":84714}}},"castSpell":{"spellId":{"spellId":84714}}}},{"action":{"condition":{"and":{"vals":[{"auraIsActive":{"auraId":{"spellId":112965}}},{"cmp":{"op":"OpGe","lhs":{"spellTimeToReady":{"spellId":{"spellId":108978}}},"rhs":{"const":{"val":"10s"}}}}]}},"castSpell":{"spellId":{"spellId":30455}}}},{"action":{"castSpell":{"spellId":{"spellId":116}}}}]]],
        --prepull_json = [[[{"action":{"castSpell":{"spellId":{"spellId":31687}}},"doAtValue":{"const":{"val":"-15s"}}},{"action":{"castSpell":{"spellId":{"spellId":7302}}},"doAtValue":{"const":{"val":"-8s"}}},{"action":{"castSpell":{"spellId":{"spellId":12051}}},"doAtValue":{"const":{"val":"-5s"}}},{"action":{"castSpell":{"spellId":{"spellId":116011}}},"doAtValue":{"const":{"val":"-5s"}}},{"action":{"castSpell":{"spellId":{"spellId":55342}}},"doAtValue":{"const":{"val":"-3.5s"}}},{"action":{"castSpell":{"spellId":{"spellId":116}}},"doAtValue":{"const":{"val":"-1.5s"}}},{"action":{"castSpell":{"spellId":{"otherId":"OtherActionPotion"}}},"doAtValue":{"const":{"val":"-1.5s"}}}]]]
    }
)

-- CLASSIC ROTATION CONFIG START
-- CLASSIC ROTATION CONFIG END

-- SOD ROTATION CONFIG START
-- SOD ROTATION CONFIG END

-- END OF GENERATED_ROTATIONS

--- @class Mage : ClassBase
local Mage = NAG:CreateClassModule("MAGE", defaults)
if not Mage then return end

function Mage:RegisterSpellTracking()
    local SpellTracker = NAG:GetModule("SpellTrackingManager")
    if not SpellTracker then return end
end

NAG.Class = Mage